name: ðŸš€ Build and Deploy CCCC Frontendname: Deploy 11ty to GitHub Pages

on:

on:  push:

  # Trigger on push to main branch    branches: [ "main" ]

  push:  workflow_dispatch:

    branches: [ main ]

    paths:permissions:

      - 'src/**'  contents: read

      - 'package*.json'  pages: write

      - '.eleventy.js'  id-token: write

      - '.github/workflows/**'

  concurrency:

  # Allow manual triggering  group: "pages"

  workflow_dispatch:  cancel-in-progress: true



# Set permissions for GitHub Pages deploymentjobs:

permissions:  build:

  contents: read    runs-on: ubuntu-latest

  pages: write    steps:

  id-token: write      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4

# Allow only one concurrent deployment        with: { node-version: 20 }

concurrency:      - run: npm ci

  group: "pages"      - run: npm run build

  cancel-in-progress: false      - uses: actions/upload-pages-artifact@v3

        with: { path: _site }   # <- Eleventyâ€™s output

jobs:

  # Build job  deploy:

  build:    needs: build

    name: ðŸ”¨ Build Frontend    runs-on: ubuntu-latest

    runs-on: ubuntu-latest    environment:

          name: github-pages

    steps:      url: ${{ steps.deployment.outputs.page_url }}

      - name: ðŸ“¥ Checkout repository    steps:

        uses: actions/checkout@v4      - id: deployment

        with:        uses: actions/deploy-pages@v4

          fetch-depth: 0
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ” Verify package.json
        run: |
          echo "ðŸ“‹ Package.json contents:"
          cat package.json
          echo "ðŸ”§ Available scripts:"
          npm run
          
      - name: ðŸ“š Install dependencies
        run: |
          echo "ðŸš€ Installing dependencies..."
          npm ci --prefer-offline --no-audit
          
      - name: ðŸ—ï¸ Build site with Eleventy
        run: |
          echo "ðŸ”¨ Building static site..."
          npm run build
          echo "âœ… Build completed!"
          
      - name: ðŸ“Š Build verification
        run: |
          echo "ðŸ“ Checking build output:"
          ls -la public/
          echo "ðŸ“„ Built pages:"
          find public -name "*.html" | head -10
          echo "ðŸ”— Search index:"
          ls -la public/search.json || echo "âš ï¸ Search index not found"
          echo "ðŸ“¦ Assets:"
          ls -la public/assets/ || echo "âš ï¸ Assets folder not found"
          
      - name: ðŸ”§ Setup GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ðŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public
          name: github-pages

  # Deploy job
  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ðŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: âœ… Deployment complete
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "ðŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ”— Backend URL: https://62.169.21.243"
          
  # Optional: Health check job
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
      - name: ðŸ” Check site availability
        run: |
          echo "ðŸ¥ Performing health check..."
          sleep 30  # Wait for deployment to propagate
          
          SITE_URL="https://uwaniumnya.github.io/Dyo-s-Dubious-Domain"
          
          echo "ðŸ“¡ Testing site accessibility..."
          if curl -f -s -o /dev/null "$SITE_URL"; then
            echo "âœ… Site is accessible at $SITE_URL"
          else
            echo "âŒ Site is not accessible"
            exit 1
          fi
          
          echo "ðŸ” Testing search.json..."
          if curl -f -s -o /dev/null "$SITE_URL/search.json"; then
            echo "âœ… Search index is accessible"
          else
            echo "âš ï¸ Search index not found"
          fi
          
      - name: ðŸ“Š Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend URL**: https://uwaniumnya.github.io/Dyo-s-Dubious-Domain" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend URL**: https://62.169.21.243" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY